// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// 1. ENUMS - C√°c ki·ªÉu d·ªØ li·ªáu enum
// ============================================

// Lo·∫°i h√¨nh l√†m vi·ªác
enum EmploymentType {
  FULL_TIME // Full-time: 6 ng√†y/tu·∫ßn
  PART_TIME // Part-time: 5 ca/tu·∫ßn
}

// Tr·∫°ng th√°i l·ªãch l√†m vi·ªác
enum ScheduleStatus {
  PENDING // Ch·ªù duy·ªát - nh√¢n vi√™n v·ª´a submit
  APPROVED // ƒê√£ duy·ªát - qu·∫£n l√Ω ƒë√£ x√°c nh·∫≠n
  LOCKED // ƒê√£ kh√≥a - kh√¥ng th·ªÉ ch·ªânh s·ª≠a, s·∫µn s√†ng ch·∫•m c√¥ng
}

// Tr·∫°ng th√°i y√™u c·∫ßu ngh·ªâ
enum LeaveStatus {
  PENDING // Ch·ªù duy·ªát
  APPROVED // ƒê√£ ch·∫•p nh·∫≠n
  REJECTED // ƒê√£ t·ª´ ch·ªëi
}

// Lo·∫°i ngh·ªâ
enum LeaveType {
  SICK // Ngh·ªâ ·ªëm
  EMERGENCY // B·∫•t kh·∫£ kh√°ng
  PERSONAL // C√° nh√¢n
  OTHER // Kh√°c
}

// Tr·∫°ng th√°i ch·∫•m c√¥ng
enum AttendanceStatus {
  PRESENT // C√≥ m·∫∑t
  ABSENT // V·∫Øng m·∫∑t
  LATE // ƒêi mu·ªôn
  EARLY_LEAVE // V·ªÅ s·ªõm
  ON_LEAVE // Ngh·ªâ ph√©p
}

// Th·ª© trong tu·∫ßn
enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// Lo·∫°i ca l√†m vi·ªác
enum ShiftType {
  MORNING // Ca s√°ng
  AFTERNOON // Ca chi·ªÅu
  EVENING // Ca t·ªëi
  NIGHT // Ca ƒë√™m
}

// Roles allowed in the system. Only these three values are permitted.
enum RoleName {
  MANAGER
  DEPT_MANAGER
  STAFF
}

// ============================================
// 2. ROLE & PERMISSION - Vai tr√≤ v√† quy·ªÅn h·∫°n
// ============================================

model Role {
  id          String  @id @default(uuid())
  // Use the strict enum to ensure only the three allowed roles exist
  name        RoleName  @unique
  displayName String // "Qu·∫£n l√Ω", "Tr∆∞·ªüng ph√≤ng", "Nh√¢n vi√™n"
  description String?
  level       Int     @default(0) // C·∫•p ƒë·ªô: 3=Manager, 2=DeptManager, 1=Staff

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String  @id @default(uuid())
  name        String  @unique // "manage_all_employees", "approve_schedule"
  displayName String // "Qu·∫£n l√Ω to√†n b·ªô nh√¢n vi√™n"
  resource    String // "employee", "schedule", "attendance"
  action      String // "create", "read", "update", "delete", "approve"
  description String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action])
  @@map("permissions")
}

model RolePermission {
  id String @id @default(uuid())

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now())

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// ============================================
// 3. DEPARTMENT - Ph√≤ng ban / B·ªô ph·∫≠n
// ============================================

model Department {
  id          String  @id @default(uuid())
  name        String  @unique // "Kinh doanh", "K·ªπ thu·∫≠t", "Nh√¢n s·ª±"
  code        String  @unique // "SALES", "TECH", "HR"
  description String?

  // Tr∆∞·ªüng ph√≤ng (Department Manager)
  managerId String? @unique
  manager   User?   @relation("DepartmentManager", fields: [managerId], references: [id])

  // Tr·∫°ng th√°i
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employees User[] @relation("DepartmentEmployees")

  @@map("departments")
}

// ============================================
// 4. USER - Qu·∫£n l√Ω nh√¢n vi√™n
// ============================================

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  fullName String
  phone    String?

  // Vai tr√≤ (Role t·ª´ b·∫£ng ri√™ng)
  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  // Ph√≤ng ban
  departmentId String?
  department   Department? @relation("DepartmentEmployees", fields: [departmentId], references: [id])

  // N·∫øu l√† tr∆∞·ªüng ph√≤ng
  managedDepartment Department? @relation("DepartmentManager")

  employmentType EmploymentType @default(FULL_TIME)
  isActive       Boolean        @default(true)

  // Full-time: ng√†y ngh·ªâ c·ªë ƒë·ªãnh trong tu·∫ßn
  fixedDayOff DayOfWeek?

  // Quan h·ªá ph√¢n c·∫•p t·ªï ch·ª©c (Organizational Hierarchy)
  // managerId: Ng∆∞·ªùi qu·∫£n l√Ω tr·ª±c ti·∫øp (line manager)
  // D√πng ƒë·ªÉ:
  // - Ph√™ duy·ªát l·ªãch l√†m vi·ªác
  // - Ph√™ duy·ªát ngh·ªâ ph√©p
  // - Xem b√°o c√°o c·ªßa subordinates
  managerId    String?
  manager      User?   @relation("ManagerSubordinates", fields: [managerId], references: [id])
  subordinates User[]  @relation("ManagerSubordinates")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schedules         WorkSchedule[] @relation("EmployeeSchedules")
  approvedSchedules WorkSchedule[] @relation("ApprovedSchedules")
  
  // Team membership (optional)
  // Team concept removed ‚Äî no team membership fields
  shifts            Shift[]
  attendances       Attendance[]
  leaveRequests     LeaveRequest[] @relation("EmployeeLeaveRequests")
  approvedLeaves    LeaveRequest[] @relation("ApprovedLeaveRequests")
  activityLogs      ActivityLog[]

  @@index([departmentId])
  @@index([managerId])
  @@index([roleId])
  @@map("users")
}

// ============================================
// 4. WORK SCHEDULE - L·ªãch l√†m vi·ªác theo tu·∫ßn
// ============================================
// 
// üìå QUY ƒê·ªäNH QUAN TR·ªåNG:
// - C·∫£ Full-time v√† Part-time ƒë·ªÅu PH·∫¢I ƒëƒÉng k√Ω l·ªãch tr∆∞·ªõc √≠t nh·∫•t 1 TU·∫¶N
// - KH√îNG cho ph√©p ƒëƒÉng k√Ω l·ªãch trong tu·∫ßn ƒëang di·ªÖn ra
// - KH√îNG c√≥ ƒëƒÉng k√Ω g·∫•p theo ng√†y
// - L·ªãch ph·∫£i ƒë∆∞·ª£c duy·ªát (APPROVED) tr∆∞·ªõc khi c√≥ hi·ªáu l·ª±c
// - Ch·ªâ l·ªãch ƒë√£ LOCKED m·ªõi ƒë∆∞·ª£c d√πng ƒë·ªÉ ch·∫•m c√¥ng
//
// V√≠ d·ª•: H√¥m nay l√† 14/01/2026 (Tu·∫ßn 3)
// ‚Üí Nh√¢n vi√™n ch·ªâ ƒë∆∞·ª£c ƒëƒÉng k√Ω cho Tu·∫ßn 4 tr·ªü ƒëi (t·ª´ 19/01/2026)
// ‚Üí Kh√¥ng th·ªÉ ƒëƒÉng k√Ω cho Tu·∫ßn 3 (ƒëang di·ªÖn ra)

model WorkSchedule {
  id String @id @default(uuid())

  // Th√¥ng tin tu·∫ßn l√†m vi·ªác
  // CH·ªà L∆ØU weekStartDate - c√°c tr∆∞·ªùng kh√°c t√≠nh to√°n ·ªü application layer
  weekStartDate DateTime // Ng√†y b·∫Øt ƒë·∫ßu tu·∫ßn (Monday) - tu·∫ßn ƒê∆Ø·ª¢C ƒêƒÇNG K√ù

  // Nh√¢n vi√™n
  employeeId String
  employee   User   @relation("EmployeeSchedules", fields: [employeeId], references: [id])

  // Th·ªùi ƒëi·ªÉm ƒëƒÉng k√Ω (ƒë·ªÉ validation quy ƒë·ªãnh 1 tu·∫ßn tr∆∞·ªõc)
  submittedAt DateTime @default(now()) // Th·ªùi ƒëi·ªÉm nh√¢n vi√™n submit l·ªãch

  // Tr·∫°ng th√°i
  status ScheduleStatus @default(PENDING)

  // Ng∆∞·ªùi duy·ªát
  approvedById String?
  approvedBy   User?     @relation("ApprovedSchedules", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  // Ng∆∞·ªùi kh√≥a l·ªãch (th∆∞·ªùng l√† Manager)
  lockedAt DateTime? // Th·ªùi ƒëi·ªÉm kh√≥a l·ªãch (chuy·ªÉn sang LOCKED)

  // Ghi ch√∫
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shifts Shift[]

  @@unique([employeeId, weekStartDate])
  @@index([weekStartDate, status]) // T·ªëi ∆∞u query theo tu·∫ßn v√† tr·∫°ng th√°i
  @@index([employeeId, status]) // T·ªëi ∆∞u query l·ªãch c·ªßa nh√¢n vi√™n
  @@map("work_schedules")
}

// ============================================
// 6. SHIFT - Ca l√†m vi·ªác c·ª• th·ªÉ
// ============================================

model Shift {
  id String @id @default(uuid())

  // Li√™n k·∫øt l·ªãch l√†m vi·ªác
  scheduleId String
  schedule   WorkSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  // Th√¥ng tin ca
  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])

  date      DateTime  @db.Date
  shiftType ShiftType

  // Th·ªùi gian ca l√†m vi·ªác
  startTime DateTime @db.Time
  endTime   DateTime @db.Time

  // Ghi ch√∫
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  attendance Attendance?

  @@unique([scheduleId, date, shiftType])
  @@index([date, shiftType]) // Query nhanh ca theo ng√†y v√† lo·∫°i
  @@map("shifts")
}

// ============================================
// 7. ATTENDANCE - Ch·∫•m c√¥ng th·ª±c t·∫ø
// ============================================

model Attendance {
  id String @id @default(uuid())

  // Li√™n k·∫øt ca l√†m vi·ªác
  shiftId String @unique
  shift   Shift  @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  // Nh√¢n vi√™n
  employeeId String
  employee   User   @relation(fields: [employeeId], references: [id])

  // Th·ªùi gian ch·∫•m c√¥ng th·ª±c t·∫ø
  checkInTime  DateTime?
  checkOutTime DateTime?

  // T·ªïng gi·ªù l√†m (t√≠nh b·∫±ng ph√∫t)
  totalMinutes Int?

  // Tr·∫°ng th√°i
  status AttendanceStatus @default(PRESENT)

  // Ghi ch√∫
  notes String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("attendances")
}

// ============================================
// 8. LEAVE REQUEST - Y√™u c·∫ßu ngh·ªâ ph√©p
// ============================================

model LeaveRequest {
  id String @id @default(uuid())

  // Nh√¢n vi√™n y√™u c·∫ßu
  employeeId String
  employee   User   @relation("EmployeeLeaveRequests", fields: [employeeId], references: [id])

  // Th√¥ng tin ngh·ªâ
  leaveType LeaveType
  startDate DateTime  @db.Date
  endDate   DateTime  @db.Date
  reason    String

  // Tr·∫°ng th√°i
  status LeaveStatus @default(PENDING)

  // Ng∆∞·ªùi duy·ªát
  approvedById    String?
  approvedBy      User?     @relation("ApprovedLeaveRequests", fields: [approvedById], references: [id])
  approvedAt      DateTime?
  rejectionReason String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("leave_requests")
}

// ============================================
// 9. ACTIVITY LOG - Nh·∫≠t k√Ω ho·∫°t ƒë·ªông
// ============================================

model ActivityLog {
  id String @id @default(uuid())

  // Ng∆∞·ªùi th·ª±c hi·ªán
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Th√¥ng tin ho·∫°t ƒë·ªông
  action   String // VD: "CREATE_SCHEDULE", "APPROVE_LEAVE", "CHECK_IN"
  entity   String // VD: "WorkSchedule", "LeaveRequest", "Attendance"
  entityId String? // ID c·ªßa entity ƒë∆∞·ª£c t√°c ƒë·ªông

  // Chi ti·∫øt
  description String
  metadata    Json? // D·ªØ li·ªáu b·ªï sung d·∫°ng JSON

  // IP v√† User Agent
  ipAddress String?
  userAgent String?

  // Timestamp
  createdAt DateTime @default(now())

  @@map("activity_logs")
}
