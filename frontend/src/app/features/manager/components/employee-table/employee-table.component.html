<!-- Loading State -->
<div *ngIf="isLoading()" class="text-center py-12">
  <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-gray-200 border-t-indigo-600"></div>
  <p class="text-gray-500 mt-4">Đang tải...</p>
</div>

<!-- Error State -->
<div *ngIf="error() && !isLoading()" class="text-center py-12">
  <p class="text-red-500">{{ error() }}</p>
  <button (click)="onReload()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
    Thử lại
  </button>
</div>

<!-- Table Content -->
<div *ngIf="!isLoading() && !error()" (click)="closeDropdown()">
  <table class="w-full table-fixed">
    <thead class="sticky top-0 bg-white border-b border-gray-200">
      <tr class="text-left">
        <th class="py-3 px-4 text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
          <input type="checkbox" class="rounded border-gray-300">
        </th>
        <th class="py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider w-64">Name</th>
        <th class="py-2 px-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Department</th>
        <th class="py-2 px-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Role</th>
        <th class="py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider w-52">Reports To</th>
        <!-- <th class="py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Team Size</th> -->
        <th class="py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Status</th>
        <th class="py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Employment</th>
        <th class="py-2 px-3 text-xs font-medium text-gray-500 uppercase tracking-wider text-right w-20">Actions</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200">
      <tr *ngFor="let employee of employees()" class="hover:bg-gray-50">
        <td class="py-4 px-4">
          <input type="checkbox" class="rounded border-gray-300">
        </td>
        <td class="py-4 px-4">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 flex-shrink-0 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white text-xs font-semibold">
              {{ getInitials(employee.fullName) }}
            </div>
            <div class="min-w-0 flex-1">
              <div class="text-sm font-medium text-gray-900">{{ employee.fullName }}</div>
              <div class="text-xs text-gray-500">{{ employee.email }}</div>
            </div>
          </div>
        </td>
        <td class="py-4 px-2">
          <div *ngIf="employee.department" class="flex items-center gap-1">
            <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">
              {{ employee.department.code }}
            </span>
          </div>
          <span *ngIf="!employee.department" class="text-sm text-gray-400">N/A</span>
        </td>
        <td class="py-4 px-2">
          <span class="px-2 py-1 text-xs font-medium rounded-full inline-block" 
            [ngClass]="{
              'bg-red-100 text-red-700': employee.role.level === 4,
              'bg-purple-100 text-purple-700': employee.role.level === 3,
              'bg-indigo-100 text-indigo-700': employee.role.level === 2,
              'bg-gray-100 text-gray-700': employee.role.level === 1
            }"
            [title]="employee.role.displayName">
            {{ employee.role.displayName }}
          </span>
        </td>
        
        <td class="py-4 px-4">
          <div *ngIf="employee.manager" class="flex items-center gap-2 min-w-0">
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-gray-400 to-gray-600 flex items-center justify-center text-white text-xs font-semibold flex-shrink-0">
              {{ getInitials(employee.manager.fullName) }}
            </div>
            <div class="min-w-0 flex-1">
              <div class="text-sm font-medium text-gray-900 truncate" [title]="employee.manager.fullName">
                {{ employee.manager.fullName }}
              </div>
              <div class="text-xs text-gray-500 truncate" [title]="employee.manager.role.displayName">
                {{ employee.manager.role.displayName }}
              </div>
            </div>
          </div>
          <!-- <span *ngIf="!employee.manager" class="text-sm text-gray-400">Top Level</span> -->
        </td>
        <!-- <td class="py-4 px-4">
          <div *ngIf="employee.subordinatesCount !== undefined && employee.subordinatesCount > 0" class="flex items-center gap-2">
            <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700">
              {{ employee.subordinatesCount }} {{ employee.subordinatesCount === 1 ? 'person' : 'people' }}
            </span>
          </div>
          <span *ngIf="employee.subordinatesCount === undefined || employee.subordinatesCount === 0" class="text-sm text-gray-400">—</span>
        </td> -->
        <td class="py-4 px-4">
          <span class="px-2 py-1 text-xs font-medium rounded-full" 
            [ngClass]="employee.isActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
            {{ employee.isActive ? 'Active' : 'Inactive' }}
          </span>
        </td>
        <td class="py-4 px-4 text-sm text-gray-900">{{ formatEmploymentType(employee.employmentType) }}</td>
        <td class="py-4 px-4">
          <div class="flex items-center justify-end relative">
            <button 
              (click)="toggleDropdown(employee.id, $event)"
              [disabled]="employee.role.name === 'MANAGER'"
              class="p-2 hover:bg-gray-100 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
              [title]="employee.role.name === 'MANAGER' ? 'Cannot modify Manager' : 'Actions'">
              <i-lucide [img]="MoreVertical" class="w-5 h-5 text-gray-600"></i-lucide>
            </button>

            <!-- Dropdown Menu -->
            <div 
              *ngIf="isDropdownOpen(employee.id)"
              class="absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"
              (click)="$event.stopPropagation()">
              <div class="py-1">
                <button
                  (click)="onAction('toggle-status', employee)"
                  class="w-full px-4 py-2 text-left text-sm hover:bg-gray-50 flex items-center gap-3"
                  [ngClass]="employee.isActive ? 'text-red-600' : 'text-green-600'">
                  <i-lucide [img]="employee.isActive ? UserX : UserCheck" class="w-4 h-4"></i-lucide>
                  <span>{{ employee.isActive ? 'Deactivate' : 'Activate' }}</span>
                </button>
                
                <button
                  (click)="onAction('reset-password', employee)"
                  class="w-full px-4 py-2 text-left text-sm text-blue-600 hover:bg-gray-50 flex items-center gap-3">
                  <i-lucide [img]="RefreshCw" class="w-4 h-4"></i-lucide>
                  <span>Reset Password</span>
                </button>
                
                <button
                  (click)="onAction('edit', employee)"
                  class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
                  <i-lucide [img]="Edit" class="w-4 h-4"></i-lucide>
                  <span>Edit</span>
                </button>

                <button
                  (click)="onAction('view', employee)"
                  class="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-3">
                  <i-lucide [img]="Eye" class="w-4 h-4"></i-lucide>
                  <span>View</span>
                </button>
                
                <div class="border-t border-gray-200 my-1"></div>
                
                <button
                  (click)="onAction('delete', employee)"
                  class="w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-gray-50 flex items-center gap-3">
                  <i-lucide [img]="Trash2" class="w-4 h-4"></i-lucide>
                  <span>Delete</span>
                </button>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Empty State -->
  <div *ngIf="employees().length === 0" class="text-center py-12">
    <i-lucide [img]="Users" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i-lucide>
    <p class="text-gray-500">No employees found</p>
  </div>

  <!-- Pagination -->
  <div *ngIf="employees().length > 0" class="flex items-center justify-between py-4 border-t border-gray-200 mt-4">
    <div class="text-sm text-gray-500">
      Showing {{ (currentPage() - 1) * pageSize() + 1 }} to {{ Math.min(currentPage() * pageSize(), totalEmployees()) }} of {{ totalEmployees() }} employees
    </div>
    <div class="flex gap-2">
      <button 
        (click)="onPageChange(currentPage() - 1)"
        [disabled]="currentPage() === 1"
        class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
        Previous
      </button>
      <button 
        *ngFor="let page of getPageNumbers(); let i = index"
        (click)="onPageChange(i + 1)"
        [class]="(i + 1) === currentPage() 
          ? 'px-3 py-1 bg-indigo-600 text-white rounded-lg' 
          : 'px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50'">
        {{ i + 1 }}
      </button>
      <button 
        (click)="onPageChange(currentPage() + 1)"
        [disabled]="currentPage() >= totalPages"
        class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
        Next
      </button>
    </div>
  </div>
</div>
