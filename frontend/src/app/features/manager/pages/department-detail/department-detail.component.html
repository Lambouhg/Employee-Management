<ng-container *ngIf="department$ | async as department; else loadingOrError">
    <!-- Breadcrumb & Header -->
    <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-700 px-8 py-6">
        <div class="max-w-7xl mx-auto">
            <!-- Breadcrumb -->
            <nav class="flex items-center gap-2 text-sm text-indigo-100 mb-4">
                <a routerLink="/manager/departments" class="hover:text-white transition-colors">Departments</a>
                <span>/</span>
                <span class="text-white font-medium">{{ department.name }}</span>
            </nav>

            <!-- Header -->
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button (click)="goBack()"
                        class="p-2 bg-white/20 hover:bg-white/30 rounded-lg backdrop-blur-sm transition-colors">
                        <i-lucide [img]="ArrowLeft" class="w-5 h-5 text-white"></i-lucide>
                    </button>
                    <div class="text-white">
                        <div class="flex items-center gap-3 mb-1">
                            <div class="p-2 bg-white/20 rounded-lg backdrop-blur-sm">
                                <i-lucide [img]="Building2" class="w-6 h-6"></i-lucide>
                            </div>
                            <h1 class="text-2xl font-bold">{{ department.name }}</h1>
                        </div>
                        <p class="text-indigo-100">Department Details & Team Management</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button (click)="openDepartmentForm()"
                        class="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-xl flex items-center gap-2 font-medium backdrop-blur-sm transition-colors">
                        <i-lucide [img]="Edit" class="w-4 h-4"></i-lucide>
                        <span>Edit</span>
                    </button>
                    <button (click)="deleteDepartment(department)"
                        class="px-4 py-2 bg-red-500/80 hover:bg-red-600 text-white rounded-xl flex items-center gap-2 font-medium backdrop-blur-sm transition-colors">
                        <i-lucide [img]="Trash2" class="w-4 h-4"></i-lucide>
                        <span>Delete</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="flex-1 p-8 bg-gray-50 min-h-screen">
        <div class="max-w-7xl mx-auto">
            <!-- Department Details -->
            <div class="space-y-6">
                <!-- Info Cards Row -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Department Info Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Department Info
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Department Name</p>
                                <p class="font-semibold text-gray-900">{{ department.name }}</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Department Code</p>
                                <p
                                    class="font-mono text-sm font-medium text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg inline-block">
                                    {{ department.code }}</p>
                            </div>
                            <div *ngIf="department.description">
                                <p class="text-xs text-gray-500 mb-1">Description</p>
                                <p class="text-sm text-gray-700">{{ department.description }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Manager Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Department Manager
                            </h3>
                            <button (click)="openAssignManager()"
                                class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                                {{ department.manager ? 'Change' : 'Assign' }}
                            </button>
                        </div>

                        <div *ngIf="department.manager" class="space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <div
                                        class="w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold shadow-md">
                                        {{ getInitials(department.manager.fullName) }}
                                    </div>
                                    <div
                                        class="absolute -bottom-0.5 -right-0.5 w-4 h-4 bg-green-500 rounded-full border-2 border-white">
                                    </div>
                                </div>
                                <div class="min-w-0 flex-1">
                                    <p class="font-semibold text-gray-900">{{ department.manager.fullName }}</p>
                                    <p class="text-sm text-gray-500 flex items-center gap-1">
                                        <i-lucide [img]="Mail" class="w-3 h-3"></i-lucide>
                                        {{ department.manager.email }}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="!department.manager"
                            class="flex flex-col items-center justify-center py-6 text-center">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                <i-lucide [img]="UserPlus" class="w-6 h-6 text-gray-400"></i-lucide>
                            </div>
                            <p class="text-sm font-medium text-gray-500 mb-1">No manager assigned</p>
                            <button (click)="openAssignManager()"
                                class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                                Assign Manager
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Card -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Statistics</h3>
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="p-2 bg-indigo-100 rounded-lg">
                                        <i-lucide [img]="Users" class="w-4 h-4 text-indigo-600"></i-lucide>
                                    </div>
                                    <span class="text-sm text-gray-600">Total Employees</span>
                                </div>
                                <span class="text-2xl font-bold text-gray-900">{{ department.statistics?.totalEmployees
                                    ||
                                    department._count?.employees || 0 }}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="p-2 bg-green-100 rounded-lg">
                                        <i-lucide [img]="Briefcase" class="w-4 h-4 text-green-600"></i-lucide>
                                    </div>
                                    <span class="text-sm text-gray-600">Active</span>
                                </div>
                                <span class="text-xl font-bold text-green-600">{{ department.statistics?.activeEmployees
                                    ||
                                    0 }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employees Section -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Team Members</h3>
                                <p class="text-sm text-gray-500 mt-1">{{ department.employees?.length || 0 }} employees
                                    in
                                    this department</p>
                            </div>
                            <button (click)="openManageEmployees()"
                                class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 flex items-center gap-2 font-medium transition-colors">
                                <i-lucide [img]="Users" class="w-4 h-4"></i-lucide>
                                <span>Manage Employees</span>
                            </button>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div *ngIf="!department.employees || department.employees.length === 0" class="p-12 text-center">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-100 rounded-full mb-4">
                            <i-lucide [img]="UserPlus" class="w-8 h-8 text-gray-400"></i-lucide>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-900 mb-2">No employees yet</h4>
                        <p class="text-gray-500 mb-6">Add employees to this department to get started</p>
                        <button (click)="openManageEmployees()"
                            class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 inline-flex items-center gap-2 font-medium">
                            <i-lucide [img]="UserPlus" class="w-5 h-5"></i-lucide>
                            Add Employees
                        </button>
                    </div>

                    <!-- Employee List -->
                    <div *ngIf="department.employees && department.employees.length > 0"
                        class="divide-y divide-gray-100">
                        <div *ngFor="let emp of department.employees" class="p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4 min-w-0 flex-1">
                                    <div
                                        class="w-11 h-11 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white text-sm font-medium flex-shrink-0">
                                        {{ getInitials(emp.fullName) }}
                                    </div>
                                    <div class="min-w-0 flex-1">
                                        <p class="font-semibold text-gray-900">{{ emp.fullName }}</p>
                                        <div class="flex items-center gap-3 mt-1">
                                            <p class="text-sm text-gray-500 flex items-center gap-1">
                                                <i-lucide [img]="Mail" class="w-3 h-3"></i-lucide>
                                                {{ emp.email }}
                                            </p>
                                            <span *ngIf="emp.phone" class="text-sm text-gray-500">{{ emp.phone }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 flex-shrink-0">
                                    <span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-medium">
                                        {{ emp.role?.displayName || 'N/A' }}
                                    </span>
                                    <span class="px-3 py-1 rounded-lg text-sm font-medium" [ngClass]="{
                    'bg-green-50 text-green-700': emp.isActive,
                    'bg-gray-100 text-gray-600': !emp.isActive
                  }">
                                        {{ emp.isActive ? 'Active' : 'Inactive' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <app-department-form-modal *ngIf="showDepartmentForm && departmentId" [departmentId]="departmentId"
        [department]="department" (closed)="closeDepartmentForm()" (saved)="onDepartmentSaved()">
    </app-department-form-modal>

    <app-assign-manager-modal *ngIf="showAssignManager" [departmentId]="departmentId!" [department]="department"
        [managers]="departmentManagers" (closed)="closeAssignManager()" (saved)="onManagerAssigned()">
    </app-assign-manager-modal>

    <app-manage-employees-modal *ngIf="showManageEmployees" [departmentId]="departmentId!" [department]="department"
        [allEmployees]="employees" (closed)="closeManageEmployees()" (saved)="onEmployeesManaged()">
    </app-manage-employees-modal>
</ng-container>

<!-- Loading/Error Template -->
<ng-template #loadingOrError>
    <!-- Loading State -->
    <div *ngIf="!errorMessage" class="flex flex-col items-center justify-center py-20 min-h-screen bg-gray-50">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-indigo-200 rounded-full animate-spin border-t-indigo-600">
            </div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i-lucide [img]="Building2" class="w-6 h-6 text-indigo-600"></i-lucide>
            </div>
        </div>
        <p class="text-gray-500 mt-4 font-medium">Loading department details...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage"
        class="text-center py-20 min-h-screen bg-gray-50 flex flex-col items-center justify-center">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-red-100 rounded-full mb-4">
            <i-lucide [img]="Building2" class="w-10 h-10 text-red-600"></i-lucide>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">Failed to load department</h3>
        <p class="text-gray-500 mb-6 px-4">{{ errorMessage }}</p>
        <button (click)="goBack()"
            class="px-6 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 inline-flex items-center gap-2 font-medium shadow-sm transition-all focus:ring-2 focus:ring-indigo-500">
            <i-lucide [img]="ArrowLeft" class="w-5 h-5"></i-lucide>
            Back to Departments
        </button>
    </div>
</ng-template>